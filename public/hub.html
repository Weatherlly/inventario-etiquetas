<!DOCTYPE html>
<html lang="pt-br">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Hub de Invent√°rio</title>
    <link rel="stylesheet" href="style.css">
</head>
<body>
    <div class="container">
        <header>
            <h1>üì¶ Gest√£o de Invent√°rio</h1>
        </header>

        <div id="status-card" class="card card-status"></div>

        <div style="display:flex; justify-content: space-between; align-items: center; margin-top: 30px;">
            <h3>Hist√≥rico de Invent√°rios</h3>
            <button onclick="limparInventarioAtual()" class="btn-outline" style="color:var(--danger); border-color:var(--danger)">üóëÔ∏è Limpar Rascunho Atual</button>
        </div>

        <div class="card" style="padding:0; margin-top:10px;">
            <table>
                <thead>
                    <tr>
                        <th>Data</th>
                        <th style="text-align:right">A√ß√µes</th>
                    </tr>
                </thead>
                <tbody id="lista-historico"></tbody>
            </table>
        </div>
    </div>

    <script>
        async function init() {
            const res = await fetch('/api/hub-status');
            const data = await res.json();
            
            const card = document.getElementById('status-card');
            card.innerHTML = data.rodando
                ? `<span class="badge status-rodando">EM ANDAMENTO</span><p>Invent√°rio aberto detectado.</p><button onclick="location.href='index.html'" class="btn-primary">Continuar</button>`
                : `<span class="badge status-limpo">SISTEMA LIVRE</span><p>Pronto para novo invent√°rio.</p><button onclick="location.href='index.html'" class="btn-success">Iniciar Novo</button>`;

            document.getElementById('lista-historico').innerHTML = data.historico.map(h => `
                <tr>
                    <td><strong>${h.data}</strong></td>
                    <td style="text-align:right">
                        <button class="btn-outline" onclick="location.href='/api/exportar-csv?id=${h.id}'">üì• CSV</button>
                        <button class="btn-outline" style="color:var(--danger)" onclick="excluirHistorico(${h.id})">üóëÔ∏è</button>
                    </td>
                </tr>
            `).join('') || '<tr><td colspan="2" style="text-align:center; padding:20px;">Vazio</td></tr>';
        }

        async function limparInventarioAtual() {
            const senha = prompt("Digite a senha de administrador para limpar o invent√°rio em andamento:");
            if (!senha) return;

            const res = await fetch('/api/admin/limpar-atual', {
                method: 'POST',
                headers: {'Content-Type': 'application/json'},
                body: JSON.stringify({ password: senha })
            });

            if (res.ok) {
                alert("Rascunho atual removido!");
                init();
            } else {
                alert("Senha incorreta!");
            }
        }

        async function excluirHistorico(id) {
            const senha = prompt("Confirme a senha para excluir este registro permanentemente:");
            if (!senha) return;

            const res = await fetch('/api/admin/excluir-historico', {
                method: 'POST',
                headers: {'Content-Type': 'application/json'},
                body: JSON.stringify({ password: senha, id: id })
            });

            if (res.ok) {
                alert("Registro exclu√≠do com sucesso!");
                init();
            } else {
                alert("Senha incorreta!");
            }
        }

        init();
    </script>
</body>
</html>